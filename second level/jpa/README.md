[Вернуться к оглавлению](https://github.com/engine-it-in/different-level-task/blob/main/README.md)
***
* [Java Persistence API (JPA)](#java-persistence-api--jpa-)
  * [What is JPA](#what-is-jpa)
    * [Подход к работе с данными](#подход-к-работе-с-данными)
    * [Настройка и конфигурация](#настройка-и-конфигурация)
    * [Генерация SQL-запросов](#генерация-sql-запросов)
    * [Поддержка кэширования](#поддержка-кэширования)
    * [Работа со сложными связями между объектами](#работа-со-сложными-связями-между-объектами)
    * [Изучаемость и простота использования](#изучаемость-и-простота-использования)
    * [Производительность](#производительность)
    * [Сообщество и поддержка](#сообщество-и-поддержка)
  * [General annotations](#general-annotations)
    * [@Query](#query)
  * [General rules](#general-rules)
  * [Hikari](#hikari)
  * [Flyway](#flyway)
  * [General properties](#general-properties)
***

# Java Persistence API (JPA)

## What is JPA
* JPA - это API, набор правил для работы с БД; 
* Технологии - Hibernate, MyBatis реализует эти правила;

### Подход к работе с данными

* Использует объектно-реляционное отображение (ORM);
* Сопоставляет Java-объекты с таблицами базы данных;
* Требует минимум взаимодействия с SQL;

### Настройка и конфигурация

* Использует аннотации или XML-файлы для настройки мапинга;
* Чаще всего требует начальной настройки EntityManager'а и persistence-unit;

### Генерация SQL-запросов

* Обеспечивает автоматическую генерацию SQL-запросов;
* Запросы создаются на основе написанных Java объектов и их аннотаций;

### Поддержка кэширования

* Встроенная поддержка кэширования (например, L1 и L2);
* Поддержка различных стратегий кэширования;

### Работа со сложными связями между объектами

* Отлично подходит для работы со сложными отношениями между объектами (например, @OneToMany, @ManyToMany).
* Автоматически обрабатывает каскадные операции и управление целостностью данных;

### Изучаемость и простота использования

* Предоставляет высокий уровень абстракции;
* Сложно для новичков из-за обилия аннотаций и конфигурационных параметров;

### Производительность

* Производительность зависит от реализации и настройки;
* Автоматическое управление транзакциями и жадное выполнение запросов могут иногда снижать производительность;

### Сообщество и поддержка

* Имеет большое и активное сообщество;
* Официальная спецификация поддерживается Oracle и другими представителями Java-экосистемы;

## General annotations

Основные аннотации:

| Annotation        | Description                                                                                                              |
|-------------------|--------------------------------------------------------------------------------------------------------------------------|
| `@Table`          | таблица БД (может сожержать `@Indexes`)                                                                                  |
| `@Entity`         | сущность (класс), представляющий запись таблицы БД                                                                       |
| `@Column`         | поле класса (`@Entity`), описывающее колонку таблицы БД                                                                  |
| `@Id`             | уникальный ключ                                                                                                          |
| `@EmbeddedId`     | уникальный ключ (составной)                                                                                              |
| `@Embeddable`     | класс, который может являться составным ключом (тогда поле в `@Entity` его типа будет содержать аннотацию `@EmbeddedId`) |
| `@GeneratedValue` | значение генерируется при сохранении (новое)                                                                             |

### @Query

Внутри аннотации @Query можно указать запрос на SQL:

```java

@Repository
public interface EmployeeRepository extends JpaRepository<Employee, Integer> {
    @Query(value = "SELECT * FROM employees WHERE emp_id = ?1", nativeQuery = true)
    Employee findByEmpId(int empId);
}
```

Указываем nativeQuery = true, чтобы указать, что запрос является native SQL.

## General rules

Основные правила `@Entity`:

- Должен быть отмечен как `@Entity`;
- Должен содержать первичный ключ (`@Id` или  `@EmbeddedId`);
- Должен быть top-level классом;
- Должен иметь `public` или `protected` конструктор без параметров;
- Должен имплементировать `Serializable` если состояние передается во-вне;
- Не должен быть `enum`;
- Не должен быть `interface`;
- Не должен быть `final`;
- Поля `@Entity` не должны быть доступны напрямую (только через getter и setter);
- Поля `@Entity` не должны быть `final`;

Для выполнения действий с БД создается интерфейс, наследующий JpaRepository<T, ID> (в случае JPA)

## Hikari

* HikariCP - это пул соединений (connection pool) для управления соединениями с базой данных в приложениях Spring Boot; 
* HikariCP автоматически управляет открытием и закрытием соединений с базой данных, а также их переиспользованием; 
* По-умолчанию, HikariCP создает 10 соединений с базой данных в Spring Boot. Однако, этот параметр может быть изменен путем
настройки свойства spring.datasource.hikari.maximum-pool-size;

## Flyway

* Инструмент, позволяющий сохранять версионность БД. Накатывает миграции на БД, создавая таблицу, в которой хранит данные
о ранее примененных миграциях. Таким образом, история изменения БД хранится в сервисе. Сервис подготавливает БД перед
запуском.

## General properties

```yaml
spring:
  datasource:
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 5
    password: pass
    url: jdbc:postgresql://localhost:5432/kasko_quote
    username: kasko_quote_crud_user
  flyway:
    password: pass
    schemas: kasko
    url: jdbc:postgresql://localhost:5432/kasko_quote
    user: kasko_quote_crud_user
  jpa:
    database-platform: org.hibernate.dialect.PostgreSQL95Dialect
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        temp.use_jdbc_metadata_defaults: false
```